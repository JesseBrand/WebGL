<html>
	<head>
		<link href="style.css" rel="stylesheet" />
		<script type="text/javascript" src="../../lib/three.js"></script>
		<script type="text/javascript" src="../../lib/OrbitControls.js"></script>
		<script type="text/javascript" src="controls.js"></script>
		<script type="text/javascript" src="pointerlock.js"></script>
		<script type="text/javascript" src="keyhandler.js"></script>
		<script type="text/javascript" src="ImprovedNoise.js"></script>
		<script type="text/javascript" src="stereo.js"></script>
		<script type="text/javascript" src="CSS3DRenderer.js"></script>
		<script type="text/javascript">

var vr = false;

var siteScaleFactor = 10;

var width = vr ? 800 : 1600;
var height = vr ? 400 : 753;

var camera;

var glScene;
var glRenderer;
var glCameraView;

var cssScene;
var cssRenderer;
var cssCameraView;

var ship;

var worldWidth = 1024;
var worldDepth = 1024;

var moveForward;
var moveBackward;
var moveUp;
var moveDown;
var moveLeft;
var moveRight;
var pause = false;

var velocity = new THREE.Vector3();

function init() {
	
	camera = new THREE.PerspectiveCamera(90, width / height, .1, 1000);
	
	createCssRenderer();
	createGLRenderer();
		
//	document.body.appendChild(glRenderer.domElement);
	
	document.body.appendChild(cssRenderer.domElement);
	cssRenderer.domElement.appendChild(glRenderer.domElement);
	
	document.getElementById('blocker').style.width = width;
	document.getElementById('blocker').style.height = height;
	
	addDebug(scene);
	
	addTerrain(scene);

	addLights(scene);
	
	addBrighterBusiness(scene);
	
//	initOrbitControls(camera, glRenderer, scene);
	initMyControls(camera, glRenderer, scene);

	render();
}

function createGLRenderer() {
	scene = new THREE.Scene();
	
	glRenderer = new THREE.WebGLRenderer({alpha: true});
	glRenderer.setSize(width, height);
	glRenderer.domElement.id = 'glRenderer';
	
	glRenderer.shadowMap.enabled = true; 
	glRenderer.gammaOutput = true; 

	if (vr) {
		glCameraView = new THREE.StereoEffect(glRenderer, 10);
	} else {
		glCameraView = glRenderer;
	}
}

function createCssRenderer() {
	cssScene = new THREE.Scene();
	
    cssRenderer = new THREE.CSS3DRenderer();
    cssRenderer.setSize(width, height);
	cssRenderer.domElement.id = 'cssRenderer';
	
	if (vr) {
		cssCameraView = new THREE.StereoEffectCSS(cssRenderer, 10);
	} else {
		cssCameraView = cssRenderer;
	}
}

function initOrbitControls(camera, glRenderer, scene) {
	controls = new THREE.OrbitControls( camera, glRenderer.domElement );
}

function initMyControls(camera, glRenderer, scene) {
	document.addEventListener( 'keydown', keyDownHandler, false );
	document.addEventListener( 'keyup', keyUpHandler, false );
	
	controls = new THREE.MyControls( camera );
	ship = controls.getObject();
	ship.position.set(30, 60, 60);
	scene.add(ship);
	
	var light = new THREE.PointLight(0xffffff, 1, 100);
	ship.add(light);

	initPointerLock(controls);
}
function switchCursorMode() {
	if (controls.switchCursorMode) {
		controls.switchCursorMode();
	}
}


function addDebug(scene) {
	var axisHelper = new THREE.AxisHelper( 5 );
	scene.add( axisHelper );
}

function addLights(scene) {
//	scene.add(new THREE.AmbientLight(0x050510));
	
	var light = new THREE.PointLight(0x303020, 1, 500);
	light.position.set(0, 500, 100);
	scene.add(light);
}

function addBrighterBusiness(scene) {
	add3DPage(scene, 'http://www.nu.nl', 100, 100, new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, 0));
}

function add3DPage(scene, url, width, height, position, rotation) {
	var planeMat = new THREE.MeshBasicMaterial({ opacity: 0.0, color: 0x000000 });
	var planeGeo = new THREE.PlaneGeometry(width, height);
	var planeMesh = new THREE.Mesh(planeGeo, planeMat);
	planeMesh.position = position;
	planeMesh.rotation = rotation;
	scene.add(planeMesh);

	// http://adndevblog.typepad.com/cloud_and_mobile/2015/07/embedding-webpages-in-a-3d-threejs-scene.html
	
	var siteWidth = width * siteScaleFactor;
	var siteHeight = height * siteScaleFactor;
	var element = document.createElement('iframe');
	element.src = url;
	element.width = siteWidth;
	element.height = siteHeight;
	element.style = 'width:"' + siteWidth + 'px"; height:"' + siteHeight + 'px"';
	var cssObject = new THREE.CSS3DObject(element);
	cssObject.position = planeMesh.position;
	cssObject.rotation = planeMesh.rotation;
	cssObject.scale.x /= siteScaleFactor;
	cssObject.scale.y /= siteScaleFactor;
	cssObject.scale.z /= siteScaleFactor;
	cssScene.add(cssObject);
}

function addTerrain(scene) {
	var data = generateHeight( worldWidth, worldDepth );
	var geometry = new THREE.PlaneBufferGeometry( worldWidth, worldDepth, worldWidth - 1, worldDepth - 1 );
	geometry.rotateX( - Math.PI / 2 );
	var vertices = geometry.attributes.position.array;
	for ( var i = 0, j = 0, l = vertices.length; i < l; i ++, j += 3 ) {
		vertices[ j + 1 ] = data[ i ];
	}
	var world = new THREE.Mesh( geometry, new THREE.MeshPhongMaterial({color: 0xd06020}));

	scene.add(world);
}

function generateHeight( width, height ) {
	var size = width * height, data = new Uint8Array( size );
	var perlin = new ImprovedNoise();
	var quality = 64;
	var passes = 4;
	var heightFactor = .5;
	var z = Math.random() * 100;
	for ( var j = 0; j < passes; j ++ ) {
		for ( var i = 0; i < size; i ++ ) {
			var x = i % width;
			var y = ~~ ( i / width );
			data[ i ] += Math.abs( perlin.noise( x / quality, y / quality, z ) * quality * heightFactor);
		}
		quality /= 2;
	}
	return data;
}

function render() {
	requestAnimationFrame(render);

	animateCamera();

	glCameraView.render(scene, camera);
	cssCameraView.render(cssScene, camera);
}

function animateCamera() {
	velocity.set(0, 0, 0);
	if (moveForward) {
		velocity.z--;
	}
	if (moveBackward) {
		velocity.z++;
	}
	if (moveLeft) {
		velocity.x--;
	}
	if (moveRight) {
		velocity.x++;
	}
	if (moveDown) {
		velocity.y--;
	}
	if (moveUp) {
		velocity.y++;
	}
	if (pause) {
		debugger;
	}
	ship.translateX(velocity.x);
	ship.translateY(velocity.y);
	ship.translateZ(velocity.z);
}

		</script>
	</head>
	<body onload="init()">
	
		<div id="blocker">

			<div id="instructions">Click here</div>

		</div>
	</body>
</html>
